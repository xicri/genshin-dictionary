# Genshin Dictionary - Coding Agent Instructions

## Project Overview

**Genshin Dictionary** is a multilingual (English, Japanese, Simplified/Traditional Chinese) online dictionary for game terminology from Genshin Impact. It's a **SvelteKit** application deployed to Cloudflare Pages using Vite, and it includes Paraglide.js for i18n and Playwright for E2E testing.

## Architecture

### Tech Stack

- **Framework**: [SvelteKit](https://svelte.dev/docs/kit/introduction) 2.x
- **UI**: [Svelte](https://svelte.dev/docs/svelte/overview) 5.x with composition runes (`$state`, `$derived`)
- **Styling**: Using [Tailwind CSS](https://tailwindcss.com) v4, but the legacy SCSS with BEM still exists in the codebase.
- **i18n**: [Paraglide JS](https://inlang.com/m/gerre34r/library-inlang-paraglideJs) 2.x
- **Build**: Vite with `pnpm` workspace
- **Testing**: Vitest (unit), Playwright (E2E)
- **Deployment**: Cloudflare Pages (uses `wrangler`)

### Directory Structure

- `src/routes/` - Page routes (SvelteKit file-based routing with `+page.svelte`, `+layout.svelte`)
- `src/lib/` - Reusable components and functions
  - `components/` - Svelte components
  - `paraglide/` - Inlang Paraglide runtime (autogenerated)
  - `styles/` - Legacy SCSS variables and styling
- `dataset/` - Static word/tag data (JSON)
  - `words.json` - The words
  - `tags.json` - Tag definitions
  - `build/history.ts` - Update changelog
  - `redirect/` - Redirect rules for old URLs
- `messages/` - i18n message files in [Inlang Message Format](https://inlang.com/m/gerre34r/library-inlang-paraglideJs/file-formats/#inlang-message-format)
- `tests/` - Unit tests (Vitest) and E2E tests (Playwright)
- `scripts/` - Build scripts

### Data Flow

1. **At build time** (`pnpm sync`): `scripts/build.ts` generates redirect rules from `dataset/redirect/`
2. **At runtime**: `src/lib/words.ts` exports `searchWords()` which:
   - Takes query string, tag filters, locale, and max results
   - Uses `CandidateString` class for fuzzy matching (katakana normalization, symbol removal)
   - Returns ranked Word[] with priority levels (exact → variants → partial → pronunciation → notes)

## Key Patterns & Conventions

### Search Normalization (`src/lib/utils.ts`)

The `CandidateString` class handles multilingual fuzzy matching:
- Converts Katakana ‹ヴ› to Hiragana ‹ぶ› for matching "ベル" queries against "ヴェル"
- Strips symbols (（）()「」・ ) so "勤労の導き" matches "「勤労」の導き"
- Case-insensitive for Latin text
- **Important**: Always use `candidate(str).equals()` or `.includes()` for user searches, never direct string comparison

### Locale Handling

- **4 locales**: "en", "ja", "zh-CN", "zh-TW" (derived from [src/lib/paraglide/runtime.js](src/lib/paraglide/runtime.js))
- Use `getLocale()` (Paraglide) to get current locale in components
- Message keys in `messages/{locale}.json` - use `m.keyName()` function syntax:
  ```svelte
  <script lang="ts">
    import { m } from "$lib/paraglide/messages.js";
    const title = m.siteTitle();
  </script>
  ```

### Component Patterns

- **Svelte 5 runes required**: Use `$state`, `$derived`, `$effect` - not reactive declarations
- **Props**: Use `const { prop1, prop2 }: Props = $props();`
- **Intersection Observer**: [WordCard.svelte](src/lib/components/WordCard.svelte) uses IntersectionObserver for lazy-loading word items

### Styling Conventions

Use Tailwind CSS v4. The existing BEM-based SCSS styles are legacy.

### Routing Structure

- **Dynamic routes**: `[wordSlug]/+page.svelte` → loads single word detail, resets and queries store by ID
- **Tag filtering**: `tags/[slug]/+page.svelte` → initializes word search with tag filter
- **Locale prefix**: All routes prefixed with locale (enforced by Paraglide/SvelteKit routing)

## Critical Developer Workflows

### Setup & Development

```bash
pnpm install              # Install deps + fetch dataset from genshin-langdata
pnpm dev                  # Start Vite dev server (http://localhost:3000)
pnpm lint                 # ESLint + svelte-check
pnpm fix                  # Auto-fix lint issues
```

### Build

```bash
pnpm build               # Vite build to .svelte-kit/cloudflare/
pnpm sync                # Build type stubs, sync SvelteKit, run build.ts scripts
```

### Testing

```bash
pnpm test                # Run Vitest unit tests (see tests/search.test.ts)
pnpm e2e                 # Run Playwright E2E tests against local server
pnpm vrt                 # Visual regression testing
```

### Pre-commit Hook

- `pnpm prepare` runs `node scripts/postinstall.mjs` + `pnpm sync`
- Always run before committing to regenerate type stubs

## Important Gotchas & Decisions

### Word Matching Algorithm Has 6 Priority Levels

When writing search tests or fixing search bugs, understand [src/lib/words.ts](src/lib/words.ts) function `searchWords()`:
1. **Exact match**: Direct en/ja/zhCN/zhTW or pronunciationJa match
2. **Variant match**: Match with word.variants arrays
3. **Partial match**: Substring match in main fields
4. **Partial variant**: Substring match in variants
5. **Pronunciation**: Partial match in pronunciationJa
6. **Notes**: Locale-specific notes fields only (ja notes on ja UI, etc.)

### Dataset Is Immutable at Runtime

- `dataset/words.json` and `dataset/tags.json` are bundled at build time
- Cannot add/edit words via this repo—redirect to [genshin-langdata](https://github.com/xicri/genshin-langdata)
- Redirects managed in `dataset/redirect/` (auto-generated into `static/_redirects` by build.ts)

### Paraglide Messages Not Vue i18n

- Messages are **static** functions, not dynamic reactive translations
- For dynamic content, pass as parameters: `m.wordCount({ count: 42 })`
- No runtime message switching—locale fixed per request/page load

## Testing Strategy

### Unit Tests (Vitest)

- Location: *.test.ts
- Mock data: Uses actual `words.json` dataset

### E2E Tests (Playwright)

- Location: e2e/*.e2e.ts
- Tests across 3 browsers: Chromium (desktop/mobile), Safari (mobile)
- Deployment: CI runs E2E on each PR

### Visual Regression Testing (reg-suit)

- Uses reg-suit for screenshot comparison
- Script: `pnpm vrt` starts server, captures screenshots, compares to baseline
- Config: [regconfig.json](regconfig.json)

## Code Review Notes

- **Messages**: Add to all 4 message files (en.json, ja.json, zh-CN.json, zh-TW.json) simultaneously

## References

- [Genshin Language Data (Translation Source)](https://github.com/xicri/genshin-langdata)
- [README.md](README.md) - Development setup & tech stack overview
- [CONTRIBUTING.md](CONTRIBUTING.md) - CLA requirements, forbidden content rules
